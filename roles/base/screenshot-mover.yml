---
- name: Ensure pipx is installed
  when: screenshot_monitor_ensure_uv | bool
  block:
    - name: Check if pipx is installed
      command: which pipx
      register: pipx_check
      changed_when: false
      failed_when: false

    - name: Install pipx via apt
      apt:
        name: pipx
        state: present
      become: true
      when: pipx_check.rc != 0

    - name: Ensure pipx path is in environment
      command: pipx ensurepath
      when: pipx_check.rc != 0
      changed_when: false

- name: Ensure uv is installed via pipx
  when: screenshot_monitor_ensure_uv | bool
  block:
    - name: Check if uv is installed
      command: which uv
      register: uv_check
      changed_when: false
      failed_when: false

    - name: Install uv via pipx if not present
      command: pipx install uv
      when: uv_check.rc != 0

- name: Ensure directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ screenshot_monitor_install_dir }}"
    - "{{ screenshot_monitor_service_dir }}"
    - "{{ screenshot_monitor_source_dir }}"

- name: Deploy screenshot monitor script
  copy:
    src: screenshot_monitor.py
    dest: "{{ screenshot_monitor_install_dir }}/screenshot_monitor.py"
    mode: '0755'
  notify: restart screenshot-monitor

- name: Deploy systemd user service
  template:
    src: screenshot-monitor.service.j2
    dest: "{{ screenshot_monitor_service_dir }}/screenshot-monitor.service"
    mode: '0644'
  notify:
    - reload systemd user daemon
    - restart screenshot-monitor

- name: Check if systemd user bus is available
  command: systemctl --user status
  register: systemd_user_check
  changed_when: false
  failed_when: false
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ ansible_user_uid }}"

- name: Reload systemd user daemon
  systemd:
    daemon_reload: true
    scope: user
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ ansible_user_uid }}"
  when: systemd_user_check.rc == 0

- name: Enable and start screenshot monitor service
  systemd:
    name: screenshot-monitor
    enabled: true
    state: started
    scope: user
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ ansible_user_uid }}"
  when: systemd_user_check.rc == 0

- name: Notify user if systemd user service could not be started
  debug:
    msg: |
      WARNING: Could not connect to systemd user bus.
      The service file has been deployed but not started.
      After logging in graphically, run:
        systemctl --user daemon-reload
        systemctl --user enable --now screenshot-monitor
  when: systemd_user_check.rc != 0

- name: Enable lingering for user (service starts at boot)
  command: loginctl enable-linger {{ ansible_user_id }}
  become: true
  changed_when: false
  failed_when: false
  when: screenshot_monitor_enable_lingering | bool
