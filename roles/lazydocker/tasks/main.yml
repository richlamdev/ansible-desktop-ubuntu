---
- name: "Install/Update LazyDocker"
  block:
    # Check current installation
    - name: "Check if LazyDocker is installed"
      command: "{{ lazydocker_install_path }} --version"
      register: lazydocker_current
      failed_when: false
      changed_when: false

    - name: "Extract installed version"
      set_fact:
        lazydocker_current_version: "{{ lazydocker_current.stdout | regex_search('([0-9.]+)') }}"
      when: lazydocker_current.rc == 0

    # Determine target version
    - name: "Get latest release from GitHub"
      uri:
        url: "https://api.github.com/repos/{{ lazydocker_repo }}/releases/latest"
        return_content: yes
        headers:
          Accept: "application/vnd.github.v3+json"
      register: lazydocker_release
      when: lazydocker_version == "latest"

    - name: "Set target version (latest from GitHub)"
      set_fact:
        lazydocker_target_version: "{{ lazydocker_release.json.tag_name | regex_replace('^v', '') }}"
      when:
        - lazydocker_version == "latest"
        - lazydocker_release.json.tag_name is defined

    - name: "Set target version (pinned)"
      set_fact:
        lazydocker_target_version: "{{ lazydocker_version }}"
      when: lazydocker_version != "latest"

    - name: "Fail if version could not be determined"
      fail:
        msg: "Could not determine LazyDocker version to install"
      when: lazydocker_target_version is not defined

    # Determine if installation/update is needed
    - name: "Check if update is needed"
      set_fact:
        lazydocker_needs_install: "{{ lazydocker_current_version is not defined or lazydocker_current_version != lazydocker_target_version }}"

    - name: "Display installation status"
      debug:
        msg: "LazyDocker {{ 'will be installed' if lazydocker_current_version is not defined else ('will be updated from ' + lazydocker_current_version + ' to ' + lazydocker_target_version) if lazydocker_needs_install else 'is already up to date (' + lazydocker_current_version + ')' }}"

    # Download and install
    - name: "Download LazyDocker"
      get_url:
        url: "https://github.com/{{ lazydocker_repo }}/releases/download/v{{ lazydocker_target_version }}/lazydocker_{{ lazydocker_target_version }}_Linux_x86_64.tar.gz"
        dest: "/tmp/lazydocker.tar.gz"
        mode: "0644"
      when: lazydocker_needs_install | bool

    - name: "Extract LazyDocker"
      unarchive:
        src: "/tmp/lazydocker.tar.gz"
        dest: "/tmp"
        remote_src: yes
      when: lazydocker_needs_install | bool

    - name: "Install LazyDocker binary"
      copy:
        src: "/tmp/lazydocker"
        dest: "{{ lazydocker_install_path }}"
        mode: "0755"
        remote_src: yes
      become: yes
      when: lazydocker_needs_install | bool

    - name: "Verify installation"
      command: "{{ lazydocker_install_path }} --version"
      register: lazydocker_verify
      changed_when: false
      when: lazydocker_needs_install | bool

    - name: "Display installed version"
      debug:
        msg: "LazyDocker {{ lazydocker_target_version }} installed successfully"
      when: lazydocker_needs_install | bool

  always:
    # Cleanup temporary files
    - name: "Clean up temporary files"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/lazydocker"
        - "/tmp/lazydocker.tar.gz"
      when: lazydocker_needs_install is defined and lazydocker_needs_install | bool

  tags: ['lazydocker', 'upgrade']
