---
- block:
    - name: Define Neovim binary path
      ansible.builtin.set_fact:
        nvim_bin: "{{ home_dir }}/.local/bin/nvim"

    - name: Check if Neovim binary exists
      ansible.builtin.stat:
        path: "{{ nvim_bin }}"
      register: nvim_stat

    - name: Check current Neovim version
      ansible.builtin.command: "{{ nvim_bin }} --version"
      register: nvim_current_version
      failed_when: false
      changed_when: false
      when: nvim_stat.stat.exists

    - name: Extract current Neovim version
      ansible.builtin.set_fact:
        current_version: >-
          {{ nvim_current_version.stdout | regex_search('v[0-9]+\.[0-9]+\.[0-9]+') | default('v0.0.0') | regex_replace('^v', '') }}
      when: nvim_stat.stat.exists

    - name: Fetch latest Neovim release information from GitHub
      ansible.builtin.uri:
        url: https://api.github.com/repos/neovim/neovim/releases/latest
        return_content: yes
      register: neovim_release

    - name: Extract latest version and AppImage URL
      ansible.builtin.set_fact:
        latest_version: "{{ neovim_release.json.tag_name | regex_replace('^v', '') }}"
        appimage_url: >-
          {{ neovim_release.json.assets
             | selectattr('name', 'equalto', 'nvim-linux-x86_64.appimage')
             | map(attribute='browser_download_url')
             | first }}

    - name: Display latest Neovim version
      ansible.builtin.debug:
        msg: "Latest stable Neovim version: {{ latest_version }}"

    - name: Determine if installation or upgrade is needed
      ansible.builtin.set_fact:
        needs_update: >-
          {{ not nvim_stat.stat.exists
             or current_version is not defined
             or current_version is version(latest_version, '<') }}

    - name: Display current status
      ansible.builtin.debug:
        msg: >-
          {% if not nvim_stat.stat.exists %}
          Neovim not installed. Installing version {{ latest_version }}
          {% elif current_version is version(latest_version, '<') %}
          Upgrading Neovim: {{ current_version }} â†’ {{ latest_version }}
          {% else %}
          Neovim already up to date: {{ current_version }}
          {% endif %}

    - name: Ensure installation directory exists
      ansible.builtin.file:
        path: "{{ home_dir }}/.local/bin"
        state: directory
        mode: '0755'
      when: needs_update

    - name: Download Neovim AppImage
      ansible.builtin.get_url:
        url: "{{ appimage_url }}"
        dest: "{{ nvim_bin }}"
        mode: '0755'
      when: needs_update

    - name: Verify Neovim installation
      ansible.builtin.command: "{{ nvim_bin }} --version"
      register: nvim_new_version
      changed_when: false
      when: needs_update

    - name: Display installation result
      ansible.builtin.debug:
        msg: "Neovim successfully installed/upgraded: {{ nvim_new_version.stdout_lines[0] }}"
      when: needs_update

  tags:
    - neovim
    - upgrade
